---
import { youtubeIcon, externalIcon } from "./_icons";

interface Props {
  url: string;
}

const { url } = Astro.props;

// Extract video ID from various YouTube URL formats:
//   https://www.youtube.com/watch?v=VIDEO_ID
//   https://youtu.be/VIDEO_ID
//   https://www.youtube.com/embed/VIDEO_ID
//   https://youtube.com/shorts/VIDEO_ID
//   Bare video ID (11 characters)
function getVideoId(input: string): string {
  // youtu.be short URL
  const shortMatch = input.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
  if (shortMatch) return shortMatch[1];

  // Standard watch URL with ?v= parameter
  const watchMatch = input.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
  if (watchMatch) return watchMatch[1];

  // Embed or shorts URL
  const pathMatch = input.match(/(?:embed|shorts)\/([a-zA-Z0-9_-]{11})/);
  if (pathMatch) return pathMatch[1];

  // Bare video ID
  if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;

  return "";
}

const videoId = getVideoId(url);

// Use privacy-enhanced embed domain (no cookies until playback)
const embedUrl = `https://www.youtube-nocookie.com/embed/${videoId}`;

// Canonical watch URL for the fallback link
const watchUrl = videoId ? `https://www.youtube.com/watch?v=${videoId}` : url;
---

<figure class="not-prose my-6 flex justify-center">
  <div class="w-full max-w-[550px]">
    <div class="overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50 dark:border-zinc-700 dark:bg-zinc-800/50">
      {/* Platform header */}
      <div class="flex items-center gap-2 border-b border-zinc-200 px-4 py-2.5 dark:border-zinc-700">
        <span class="text-[#FF0000]" set:html={youtubeIcon} />
        <span class="text-sm font-medium text-zinc-600 dark:text-zinc-300">YouTube</span>
      </div>

      {/* Embed iframe with 16:9 aspect ratio */}
      <div class="relative aspect-video">
        <iframe
          src={embedUrl}
          width="100%"
          height="100%"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
          loading="lazy"
          title="YouTube video"
          class="absolute inset-0 block h-full w-full border-0"
        ></iframe>
      </div>

      {/* Fallback link */}
      <div class="border-t border-zinc-200 px-4 py-2 dark:border-zinc-700">
        <a
          href={watchUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 text-sm text-zinc-500 transition-colors hover:text-[#FF0000] dark:text-zinc-400 dark:hover:text-[#ff4d4d]"
        >
          Watch on YouTube
          <span set:html={externalIcon} />
        </a>
      </div>
    </div>
  </div>
</figure>
